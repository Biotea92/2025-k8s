## Probe

ProbeëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ì»¨í…Œì´ë„ˆì˜ ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì ê²€í•´ì„œ  

- ì•„ì§ ì¤€ë¹„ ì•ˆ ëœ ì»¨í…Œì´ë„ˆì— íŠ¸ë˜í”½ì„ ì•ˆ ë³´ë‚´ê±°ë‚˜
- ì¥ì• ê°€ ë‚œ ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹œì‘í•˜ê±°ë‚˜
- ê¸°ë™ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ê¸°ë‹¤ë ¤ì£¼ëŠ” 

ë“±ì˜ í–‰ë™ì„ í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì¥ì¹˜ì´ë‹¤.  
ì¦‰, ì»¨í…Œì´ë„ˆê°€ ì˜ ì‘ë™í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ health check ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤.



### Probe ì¢…ë¥˜

- startupProbe 
    - ì»¨í…Œì´ë„ˆê°€ ì²˜ìŒ ê¸°ë™ë  ë•Œ ì„±ê³µ ì—¬ë¶€ í™•ì¸
    - ì‹¤íŒ¨ ì‹œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
    - startupProbeê°€ ì„±ê³µí•˜ê¸° ì „ì—ëŠ” livenessProbe, readinessProbeê°€ ë™ì‘í•˜ì§€ ì•ŠìŒ
- readinessProbe
    - ìš”ì²­ì„ ë°›ì„ ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ í™•ì¸ 
    - ì‹¤íŒ¨ ì‹œ íŠ¸ë˜í”½ ì°¨ë‹¨
    - ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ì€ ë˜ì§€ ì•ŠëŠ”ë‹¤. 
- livenessProbe
    - ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ë™ì‘ ì¤‘ì¸ì§€ í™•ì¸
    - ì‹¤íŒ¨ ì‹œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘

### ì‚¬ìš© ë°©ë²•

í”„ë¡œë¸Œë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•ì—ëŠ” ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆë‹¤.  

| type | ì„¤ëª… |
| -- | -- |
| httpGet | íŠ¹ì • HTTP ê²½ë¡œì— ìš”ì²­ì„ ë³´ëƒ„ |
| exec | ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ëª…ë ¹ì–´ ì‹¤í–‰ |
| tcpSocket | íŠ¹ì • í¬íŠ¸ì— ì—°ê²° ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ |
| grpc | íŠ¹ì • grpc portì— ìš”ì²­ì„ ë³´ëƒ„ |


### ì ìš© ì˜ˆì‹œ

```yaml
containers: 
    - name: app-test
      image: app-test:lastest
      ports:
      - name: http
        containerPort: 8080
      startupProbe:
        httpGet:
            path: "/startup"
            port: 8080
        periodSeconds: 5
        failureThreshold: 36
      readinessProbe:
        httpGet:
            path: "/readiness"
            port: 8080
        periodSeconds: 10
        failureThreshold: 3
      livenessProbe:
        httpGet:
            path: "/liveness"
            port: 8080
        periodSeconds: 10
        failureThreshold: 3
```

- periodSeconds: ëª‡ ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰í• ì§€ ê²°ì •í•˜ëŠ” ì˜µì…˜
- failureThreshold: ì—°ì†ìœ¼ë¡œ ëª‡ ë²ˆ ì‹¤íŒ¨í•˜ë©´ ì§„ì§œ ì‹¤íŒ¨ ë¼ê³  íŒë‹¨í•  ê²ƒì¸ì§€ 

ë”°ë¼ì„œ `periodSeconds * failureThreshold` = ìµœëŒ€ ëŒ€ê¸° ì‹œê°„


### ğŸ·ï¸ ë¯¸ì…˜ 

1. startupProbeê°€ ì‹¤íŒ¨ ë˜ë„ë¡ ì„¤ì •í•´ì„œ Podê°€ ë¬´í•œ ì¬ê¸°ë™ ìƒíƒœê°€ ë˜ë„ë¡ ì„¤ì •í•´ ë³´ì„¸ìš”. 
    - startupProbeì˜ failureThresholdì„ 1ë¡œ ì„¤ì •í•˜ë©´ í•œ ë²ˆë§Œ ì‹¤íŒ¨í•˜ë”ë¼ë„ ì¬ì‹œì‘ ë¨

    ```yaml
    startupProbe:
        httpGet:
            path: "/startup"
            port: 8080
        periodSeconds: 5
        failureThreshold: 1
    ```

2. ì¼ì‹œì  ì¥ì•  ìƒí™©(App ë‚´ë¶€ ë¶€í•˜ ì¦ê°€)ê°€ ì‹œì‘ ëœ í›„, 30ì´ˆ ë’¤ì— íŠ¸ë˜í”½ì´ ì¤‘ë‹¨ë˜ê³ , 3ë¶„ ë’¤ì—ëŠ” Appì´ ì¬ê¸°ë™ ë˜ë„ë¡ ì„¤ì •í•´ ë³´ì„¸ìš”. 
    - íŠ¸ë˜í”½ì´ ì¤‘ë‹¨ë˜ëŠ” ì˜µì…˜ì€ `readinessProbe`ì´ê³  ë¹„ì •ìƒ ì‹œ ì»¨í…Œì´ë„ˆê°€ ì¬ì‹œì‘ë˜ëŠ” ì˜µì…˜ì€ `livenessProbe`ì´ë‹¤. 
    - `periodSeconds * failureThreshold` = ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ë¯€ë¡œ 
    - ê°ê° periodSecondsì™€ failureThresholdë¥¼ ì¡°ì •í•´ì£¼ë©´ëœë‹¤. 

    ```yaml
    readinessProbe:
        httpGet:
            path: "/readiness"
            port: 8080
        periodSeconds: 10
        failureThreshold: 3
    livenessProbe:
        httpGet:
            path: "/liveness"
            port: 8080
        periodSeconds: 10
        failureThreshold: 18
    ```

3. Secret íŒŒì¼(/usr/src/myapp/datasource/postgresql-info.yaml)ì´ ì¡´ì¬í•˜ëŠ”ì§€ ì²´í¬í•˜ëŠ” readinessProbeë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.

    - [Define a live command](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-command)
    - ì¿ ë²„ë„¤í‹°ìŠ¤ ë¬¸ì„œì—ì„œ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ `exec`ë¡œ commandë¥¼ ì„¤ì •í•˜ë©´ kubeletì´ probeë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ `cat /tmp/healthy`ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œë‹¤. 
    - ëª…ë ¹ì´ ì„±ê³µí•˜ë©´ 0ì´ ë°˜í™˜ë˜ê³  kubeletì€ ì»¨í…Œì´ë„ˆê°€ ì‚´ì•„ìˆë‹¤ê³  ê°„ì£¼í•˜ë‚˜ ëª…ë ¹ì´ 0ì´ ì•„ë‹ˆë¼ë©´ kubeletì´ ì»¨í…Œì´ë„ˆë¥¼ ì£½ì´ê³  ì¬ì‹œì‘ ì‹œí‚¨ë‹¤. 
        ```yaml
        apiVersion: v1
        kind: Pod
        metadata:
        labels:
            test: liveness
        name: liveness-exec
        spec:
        containers:
        - name: liveness
            image: registry.k8s.io/busybox:1.27.2
            args:
            - /bin/sh
            - -c
            - touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 600
            livenessProbe:
            exec:
                command:
                - cat
                - /tmp/healthy
            initialDelaySeconds: 5
            periodSeconds: 5
        ```

    - ë§ˆì°¬ê°€ì§€ë¡œ ìš°ë¦¬ì˜ ì„¤ì •ì—ì„œ readinessProbeì— ì ìš©í•´ë³´ë©´ fileì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ íŠ¸ë˜í”½ì´ ì¤‘ë‹¨ ë  ê²ƒì´ë‹¤. 
        ```yaml
        readinessProbe:
            exec:
                command:
                - cat
                - /usr/src/myapp/datasource/postgresql-info.yaml
            periodSeconds: 10
            failureThreshold: 3
        ```